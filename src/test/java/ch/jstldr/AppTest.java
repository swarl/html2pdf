package ch.jstldr;

import com.openhtmltopdf.outputdevice.helper.BaseRendererBuilder;
import com.openhtmltopdf.pdfboxout.PdfRendererBuilder;
import org.apache.commons.io.FileUtils;
import org.jsoup.Jsoup;
import org.jsoup.helper.W3CDom;
import org.junit.Test;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.InputStream;
import java.nio.charset.StandardCharsets;

public class AppTest {
    @Test
    public void shouldAnswerWithTrue() {

        String htmlContent = "<html>\n" +
                "<head>\n" +
                "<style>\n" +
                "    * {\n" +
                "        font-family: 'Liberation Sans', sans-serif;\n" +
                "        margin: 0;\n" +
                "        padding: 0;\n" +
                "    }\n" +
                "\n" +
                "    .content {\n" +
                "        word-wrap: break-word;\n" +
                "        white-space:pre-wrap;\n" +
                "    }\n" +
                "</style>\n" +
                "</head>\n" +
                "<body style=\"font-size: 12px;\">\n" +
                "</table><br/><br/><div class=\"content\"><div>  Wohoo, I have some very important news  <div>   &nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C&nbsp;\u200C  </div>  <br>  <tbody>   <tr>    <td>     <table width=\"660\">      <tbody>       <tr>        <td>         <table width=\"100%\">          <tbody>           <tr>            <td>             <table width=\"100%\">               <tbody>               <tr>                <td>\u00AD</td>               </tr>               <tr>                <td>                 <table width=\"100%\">                  <tbody>                   <tr>                    <th width=\"100%\">                     <table width=\"100%\">                       <tbody>                       <tr>                        <td>                         <table width=\"100%\">                          <tbody>                           <tr>                            <td>                             <table width=\"100%\">                              <tbody>                               <tr>                                <td> <span>I am the newsletter of death <a href=\"http://news.some.url/5fhrqwkz-wmg82uhc-sa8xybo2-pvk\"><span>hier</span><span>.</span></a></span> </td>                               </tr>                              </tbody>                             </table> </td>                           </tr>                          </tbody>                         </table> </td>                       </tr>                      </tbody>                     </table> </th>                   </tr>                  </tbody>                 </table> </td>               </tr>               <tr>                <td>\u00AD</td>               </tr>              </tbody>             </table> </td>           </tr>           <tr>            <td>             <table width=\"100%\">               <tbody>               <tr>                <td width=\"10\">\u00AD</td>                <td>\u00AD</td>                <td width=\"10\">\u00AD</td>               </tr>               <tr>                <td width=\"10\">\u00AD</td>                <td>                 <table width=\"100%\">                  <tbody>                   <tr>                    <th width=\"\">                     <table width=\"100%\">                       <tbody>                       <tr>                        <td width=\"10\">\u00AD</td>                        <td>                         <table width=\"100%\">                          <tbody>                           <tr>                            <td>                             <table width=\"171\">                              <tbody>                               <tr>                                <td>  </td>                               </tr>                              </tbody>                             </table> </td>                           </tr>                          </tbody>                         </table> </td>                        <td width=\"10\">\u00AD</td>                        <td width=\"20\">\u00AD</td>                       </tr>                      </tbody>                     </table> </th>                    <th width=\"66.67%\">                     <table width=\"100%\">                       <tbody>                       <tr>                        <td width=\"10\">\u00AD</td>                        <td>                         <table width=\"100%\">                          <tbody>                           <tr>                            <td>                             <table width=\"100%\">                              <tbody>                               <tr>                                <td>\u00AD</td>                                <td width=\"10\">\u00AD</td>                               </tr>                               <tr>                                <td>                                 <table width=\"100%\">                                  <tbody>                                   <tr>                                    <td>                                     <table width=\"100%\">                                       <tbody>                                       <tr>                                        <td>\u00AD</td>                                       </tr>                                       <tr>                                        <td>                                         <table width=\"100%\">                                          <tbody>                                           <tr>                                            <th width=\"50%\">                                             <table width=\"100%\">                                               <tbody>                                               <tr>                                                <td>                                                 <table width=\"100%\">                                                  <tbody>                                                   <tr>                                                    <td>                                                     <table width=\"100\">                                                      <tbody>                                                       <tr>                                                        <td> <span><a href=\"http://news.some.url/5fhrqwkz-wmg82uhc-yn4ivcoz-xdy\">K</a></span><a href=\"http://news.some.url/5fhrqwkz-wmg82uhc-5z8jvpxe-11uc\"><span>ommentierte Mustereingaben</span></a> </td>                                                       </tr>                                                      </tbody>                                                     </table> </td>                                                   </tr>                                                  </tbody>                                                 </table> </td>                                               </tr>                                              </tbody>                                             </table> </th>                                            <th width=\"50%\">                                             <table width=\"100%\">                                               <tbody>                                               <tr>                                                <td>                                                 <table width=\"100%\">                                                  <tbody>                                                   <tr>                                                    <td>                                                     <table width=\"100\">                                                      <tbody>                                                       <tr>                                                        <td> <span><a href=\"http://news.some.url/5fhrqwkz-wmg82uhc-73ogv4gy-1bjh\">Some-<br>thing</a></span> </td>                                                       </tr>                                                      </tbody>                                                     </table> </td>                                                   </tr>                                                  </tbody>                                                 </table> </td>                                               </tr>                                              </tbody>                                             </table> </th>                                           </tr>                                          </tbody>                                         </table> </td>                                       </tr>                                       <tr>                                        <td>\u00AD</td>                                       </tr>                                      </tbody>                                     </table> </td>                                   </tr>                                  </tbody>                                 </table> </td>                                <td width=\"10\">\u00AD</td>                               </tr>                               <tr>                                <td>\u00AD</td>                                <td width=\"10\">\u00AD</td>                               </tr>                              </tbody>                             </table> </td>                           </tr>                          </tbody>                         </table> </td>                        <td width=\"10\">\u00AD</td>                       </tr>                      </tbody>                     </table> </th>                   </tr>                  </tbody>                 </table> </td>                <td width=\"10\">\u00AD</td>               </tr>               <tr>                <td width=\"10\">\u00AD</td>                <td>\u00AD</td>                <td width=\"10\">\u00AD</td>               </tr>              </tbody>             </table> </td>           </tr>           <tr>            <td>             <table width=\"100%\">               <tbody>               <tr>                <td>  </td>               </tr>              </tbody>             </table> </td>           </tr>           <tr>            <td>             <table width=\"100%\">              <tbody>               <tr>                <td width=\"20\">\u00AD</td>                <td>\u00AD</td>                <td width=\"20\">\u00AD</td>               </tr>               <tr>                <td width=\"20\">\u00AD</td>                <td> Location, Date </td>                <td width=\"20\">\u00AD</td>               </tr>              </tbody>             </table> </td>           </tr>           <tr>            <td>             <table width=\"100%\">               <tbody>               <tr>                <td width=\"20\">\u00AD</td>                <td>\u00AD</td>                <td width=\"20\">\u00AD</td>               </tr>               <tr>                <td width=\"20\">\u00AD</td>                <td>                 <table width=\"100%\">                  <tbody>                   <tr>                    <th width=\"100%\">                     <table width=\"100%\">                       <tbody>                       <tr>                        <td>                         <table width=\"100%\">                          <tbody>                           <tr>                            <td>                             <table width=\"100%\">                              <tbody>                               <tr>                                <td> <span><b>Something</b></span> </td>                               </tr>                              </tbody>                             </table> </td>                           </tr>                          </tbody>                         </table> </td>                       </tr>                      </tbody>                     </table> </th>                   </tr>                  </tbody>                 </table> </td>                <td width=\"20\">\u00AD</td>               </tr>              </tbody>             </table> </td>           </tr>           <tr>            <td>             <table width=\"100%\">              <tbody>               <tr>                <td width=\"20\">\u00AD</td>                <td>\u00AD</td>                <td width=\"20\">\u00AD</td>               </tr>               <tr>                <td width=\"20\">\u00AD</td>                <td> <span>Hello</span><br><br>There is&nbsp;<span>Some</span> text&nbsp;<span>More of it</span>. Still very long.<br>And important <a href=\"http://news.some.url/5fhrqwkz-wmg82uhc-bmo3i836-12zm\">Bundle </a>available.<br><br>I like tables.&nbsp;<br><br>And rows!<br><br><span>Yeah<br>Greeting</span> </td>                <td width=\"20\">\u00AD</td>               </tr>              </tbody>             </table> </td>           </tr>           <tr>            <td>             <table width=\"100%\">               <tbody>               <tr>                <td width=\"20\">\u00AD</td>                <td>\u00AD</td>                <td width=\"20\">\u00AD</td>               </tr>               <tr>                <td width=\"20\">\u00AD</td>                <td>                 <table width=\"100%\">                  <tbody>                   <tr>                    <th width=\"100%\">                     <table width=\"100%\">                       <tbody>                       <tr>                        <td>                         <table width=\"100%\">                          <tbody>                           <tr>                            <td>                             <table width=\"620\">                              <tbody>                               <tr>                                <td>                                 <table width=\"100%\">                                  <tbody>                                   <tr>                                    <td>                                     <table width=\"100%\">                                      <tbody>                                       <tr>                                        <td>\u00AD</td>                                       </tr>                                      </tbody>                                     </table></td>                                   </tr>                                  </tbody>                                 </table> </td>                               </tr>                              </tbody>                             </table> </td>                           </tr>                          </tbody>                         </table> </td>                       </tr>                      </tbody>                     </table> </th>                   </tr>                  </tbody>                 </table> </td>                <td width=\"20\">\u00AD</td>               </tr>              </tbody>             </table> </td>           </tr>           <tr>            <td></td>           </tr>          </tbody>         </table></td>       </tr>      </tbody>     </table></td>   </tr>  </tbody> </table></div>\n" +
                "</body>\n" +
                "</html>";
        try (ByteArrayOutputStream outputStream = new ByteArrayOutputStream();
             InputStream targetStream = new ByteArrayInputStream(htmlContent.getBytes(StandardCharsets.UTF_8));
             ByteArrayOutputStream destinationStream = new ByteArrayOutputStream()) {
            PdfRendererBuilder builder = new PdfRendererBuilder();
            builder.usePdfAConformance(PdfRendererBuilder.PdfAConformance.PDFA_2_A);
            builder.useFont(() -> AppTest.class.getClassLoader().getResourceAsStream("org/apache/pdfbox/resources/ttf/LiberationSans-Regular.ttf"),
                    "Liberation Sans");
            builder.useDefaultPageSize(210, 297, BaseRendererBuilder.PageSizeUnits.MM);
            builder.withW3cDocument(new W3CDom().fromJsoup(Jsoup.parse(htmlContent)), "");
            builder
                    .useFastMode()
                    .toStream(outputStream).run();
            FileUtils.writeByteArrayToFile(new File("test.pdf"), outputStream.toByteArray());
        } catch (Exception e) {
            throw new IllegalStateException(e.getMessage(), e);
        }
    }
}
